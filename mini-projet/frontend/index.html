<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Microservices Dashboard</title>

<style>
body{font-family:Verdana;background:#eef2f7;padding:30px}
.card{background:white;padding:20px;border-radius:10px;margin-bottom:20px;box-shadow:0 0 8px #bbb}
input,button{padding:8px;margin:5px;font-size:14px}
.success{color:green;font-weight:bold}
.error{color:red;font-weight:bold}
ul{padding-left:20px}
pre{background:#f0f0f0;padding:10px;border-radius:6px}
</style>

</head>
<body>

<h1>ğŸ”§ Tableau Microservices</h1>

<!-- PERSONNES -->
<div class="card">
<h2>ğŸ‘¥ Liste des personnes</h2>
<button onclick="fetchPersons()">ğŸ”„ Actualiser</button>
<ul id="persons"></ul>
</div>

<!-- LOGIN -->
<div class="card">
<h2>ğŸ” Connexion</h2>
<input id="uName" placeholder="Utilisateur"><br>
<input id="uPass" type="password" placeholder="Mot de passe"><br>
<button onclick="doLogin()">Se connecter</button>
<p id="loginMsg"></p>
</div>

<!-- CREATE -->
<div class="card">
<h2>â• Nouvelle personne</h2>
<input id="pName" placeholder="Nom"><br>
<button onclick="addPerson()">CrÃ©er</button>
<p id="addMsg"></p>
</div>

<!-- DELETE -->
<div class="card">
<h2>ğŸ—‘ï¸ Supprimer une personne</h2>
<input id="pDelId" placeholder="ID"><br>
<button onclick="removePerson()">Supprimer</button>
<p id="delMsg"></p>
</div>

<!-- HEALTH -->
<div class="card">
<h2>â¤ï¸ Dossier santÃ©</h2>
<input id="hId" placeholder="ID personne"><br>
<input id="hWeight" placeholder="Poids"><br>
<input id="hHeight" placeholder="Taille"><br>
<input id="hRate" placeholder="Pouls"><br>
<input id="hPress" placeholder="Tension"><br>

<button onclick="saveHealth()">ğŸ’¾ Enregistrer</button>
<button onclick="viewHealth()">ğŸ“– Voir</button>

<pre id="healthBox"></pre>
</div>

<script>
let TOKEN = "";

// Helper API
function api(url, method="GET", body=null, auth=true){
  const opts = {method, headers:{ "Content-Type":"application/json" }};
  if(body) opts.body = JSON.stringify(body);
  if(auth && TOKEN) opts.headers["Authorization"] = "Bearer "+TOKEN;

  return fetch(url, opts).then(async r=>{
    const txt = await r.text();
    if(!txt) return {};
    try{ return JSON.parse(txt); } catch(e){ return txt; }
  });
}

// ------------------------
// Connexion
// ------------------------
function doLogin(){
  api("http://auth:5003/auth","POST",{
    username: uName.value,
    password: uPass.value
  }, false).then(d=>{
    if(d.token){
      TOKEN = d.token;
      loginMsg.textContent="ConnectÃ© âœ”ï¸";
      loginMsg.className="success";
      fetchPersons();
    } else {
      loginMsg.textContent="Erreur rÃ©seau / identifiants âŒ";
      loginMsg.className="error";
    }
  }).catch(()=>{
    loginMsg.textContent="Erreur rÃ©seau";
    loginMsg.className="error";
  });
}

// ------------------------
// Liste des personnes
// ------------------------
function fetchPersons(){
  api("http://person:5001/persons","GET",null,false).then(async persons=>{
    personsElem = document.getElementById("persons");
    personsElem.innerHTML = "";

    for(const p of persons){
      let li = document.createElement("li");
      li.textContent = `${p.id} - ${p.name}`;

      if(TOKEN){
        try{
          const h = await api(`http://health:5002/health/${p.id}`);
          const weight = h.weight ?? h.weight_kg ?? null;
          const height = h.height ?? h.height_cm ?? null;
          const hr = h.heart_rate ?? h.heart_rate_bpm ?? null;
          const bp = h.blood_pressure ?? null;

          if(weight || height || hr || bp){
            li.textContent += ` | SantÃ©: ${weight ?? '-'}kg, ${height ?? '-'}cm, FC:${hr ?? '-'}, TA:${bp ?? '-'}`;
          } else {
            li.textContent += " | Aucune donnÃ©e santÃ©";
          }
        } catch(err){
          li.textContent += " | Aucune donnÃ©e santÃ©";
        }
      }
      personsElem.appendChild(li);
    }
  });
}

// ------------------------
// Ajouter personne
// ------------------------
function addPerson(){
  if(!TOKEN){ addMsg.textContent="Connectez-vous"; addMsg.className="error"; return; }

  api("http://person:5001/persons","POST",{name:pName.value})
    .then(d=>addMsg.textContent=JSON.stringify(d,null,2))
    .then(fetchPersons);
}

// ------------------------
// Supprimer personne
// ------------------------
function removePerson(){
  if(!TOKEN){ delMsg.textContent="Connectez-vous"; delMsg.className="error"; return; }

  api("http://person:5001/persons/"+pDelId.value,"DELETE")
    .then(d=>delMsg.textContent=JSON.stringify(d,null,2))
    .then(fetchPersons);
}

// ------------------------
// SantÃ©
// ------------------------
function saveHealth(){
  if(!TOKEN){ healthBox.textContent="Connectez-vous"; return; }

  api("http://health:5002/health/"+hId.value,"POST",{
    weight: hWeight.value,
    height: hHeight.value,
    heart_rate: hRate.value,
    blood_pressure: hPress.value
  }).then(d=>{
    healthBox.textContent = JSON.stringify(d,null,2);
    fetchPersons();
  });
}

function viewHealth(){
  if(!TOKEN){ healthBox.textContent="Connectez-vous"; return; }

  api("http://health:5002/health/"+hId.value)
    .then(d=>healthBox.textContent=JSON.stringify(d,null,2));
}
</script>

</body>
</html>
